import os
import random
from pathlib import Path
import torch
from torch.utils.data import Dataset


class ExeDataset(Dataset):
    def __init__(self, dataset_path, first_n_byte=2000000):
        """
        Initialize the object with a list of all files and the dataset1 type

        :param dataset_path: the directory where all the executables are located
        :param first_n_byte: how many bytes must be read of each executable
        """
        self.type = dataset_path.split(os.sep)[-1]
        self.files = [str(x) for x in Path(dataset_path).rglob('*') if x.is_file()]
        self.files = [x for x in self.files if ".DS_Store" not in x]
        random.shuffle(self.files)
        self.first_n_byte = first_n_byte

    def __len__(self):
        """
        :return: the length of the entire dataset
        """
        return len(self.files)

    def __getitem__(self, index):
        """
        Given an index, returns the corresponding samples and its belonging class

        :param index: the sample index
        :return: a pair of tensors
        """
        file_path = self.files[index]

        with open(file_path, 'rb') as binary_file:
            binary_values = [x + 1 for x in binary_file.read(self.first_n_byte)]
            binary_values += [0] * (self.first_n_byte - len(binary_values))

        file_label = 0 if file_path.split(os.sep)[-2] == 'benign' else 1

        return torch.tensor(binary_values, dtype=torch.long), torch.tensor(file_label, dtype=torch.long)
