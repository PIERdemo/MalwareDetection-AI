import pandas as pd
import torch.nn

from pathlib import Path
from torch.utils.data import DataLoader
from extract_features.api_features import extract_API
from extract_features.binary_features import extract_binary
from methods.method1 import binary_method
from methods.method3 import deep_method
from methods.method3.exe_dataset import ExeDataset


def load_features_method1(adv_folder):
    """
    Loads binary features data from a specified folder, using the 'adv_folder' parameter. Returns processed DataFrame.
    :param adv_folder: The path to the folder containing the files to extract binary features from
    :return: A DataFrame containing the extracted and processed binary feature data
    """
    binary_features = []
    files_path = [str(x) for x in Path(adv_folder).rglob('*') if x.is_file()]

    for file in files_path:
        binary_features.append(extract_binary(file))
    dataset = pd.DataFrame(binary_features).dropna().reset_index(drop=True)

    return dataset.loc[:, [x for x in dataset.columns if x.startswith('feature')]]


def load_features_method2(adv_folder):
    """
    Loads API calls features data from the files within the specified folder using method 2 and returning them in
    a DataFrame.
    :param adv_folder: The folder containing the files to extract API calls from
    :return: A DataFrame of extracted API calls
    """
    api_features = []
    files_path = [str(x) for x in Path(adv_folder).rglob('*') if x.is_file()]

    for file in files_path:
        api = extract_API(file)
        if api is not None:
            api_features.append(extract_API(file))

    dataset = pd.DataFrame(api_features).dropna().reset_index(drop=True)

    return dataset.API_calls


def load_features_method3(adv_folder, n_bytes=1e6, batch_size=32):
    """
    This function loads the data of a given folder by creating an ExeDataset and DataLoader object with the
    provided parameters.
    :param adv_folder: The folder containing the files to extract features from
    :param n_bytes: Number of bytes to consider when loading the files
    :param batch_size: Batch size for the DataLoader object
    :return: A DataLoader object containing the extracted features
    """
    dataset_adv = ExeDataset(adv_folder, first_n_byte=int(n_bytes))
    return DataLoader(dataset_adv, batch_size)


def evaluate_methods(model, X):
    """
    This function evaluates the performance of a model on a given dataset.
    :param model: Model to evaluate
    :param X: Dataset to evaluate the model on
    :return: Prints the accuracy percentage and number of exact predictions
    """
    if not isinstance(model, torch.nn.Module):
        _, labels = binary_method.test(model, X)
    else:
        labels = deep_method.test(model, X, verbose=False)['y_pred']

    exact_predictions = len([x for x in labels if x == "malware"])
    percentage = exact_predictions / len(labels) * 100.0
    print(f'[{model.__class__.__name__}] accuracy percentage of: {percentage}%')
    print(f'[{model.__class__.__name__}] {exact_predictions} exact prediction over {len(labels)} samples')
