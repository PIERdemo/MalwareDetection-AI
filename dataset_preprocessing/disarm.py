import os
from pathlib import Path
import lief
from tqdm import tqdm


def disarm_procedure(path_armed, path_disarmed):
    """
    This function disarms the binary files passed and save them in a specific directory.

    :param path_armed: Path to the directory where the armed binary files are stored.
    :param path_disarmed: Path to the directory where the disarmed binary files will be stored.
    :return: None
    """
    try:
        # Get all file paths in the armed directory
        files_path = [str(x) for x in Path(path_armed).rglob('*')
                      if x.is_file()]

        # Iterate over each file
        for file_path in tqdm(files_path):
            # Parse the binary file using lief
            binary = lief.parse(file_path)

            # Set the machine type and subsystem to unknown, in order to set the values of the flags to 0
            binary.header.machine = lief.PE.MACHINE_TYPES.UNKNOWN
            binary.optional_header.subsystem = lief.PE.SUBSYSTEM.UNKNOWN

            # Build the binary
            builder = lief.PE.Builder(binary)
            builder.build()

            # Write the disarmed binary to the disarmed directory
            path_to_write = path_disarmed + os.sep + file_path.split(os.sep)[-1]
            builder.write(path_to_write)

    except Exception as e:
        # Print the error message if any exception occurs
        print(e)

