import json
import time
from pathlib import Path
import requests
import os.path


def load_files(directory_path):
    """
    This function takes in a directory path as a parameter, scans the directory for files,
    creates a dictionary containing the file name as key and scan_id as value for each file.

    :param directory_path: string, the path of the directory to be scanned
    :return: dictionary, containing the scan_id of each file as value and file name as key
    """
    with open('files/virustotal_utils.json') as json_file:
        utils = json.load(json_file)

    files_path = [str(x) for x in Path(directory_path).rglob('*') if x.is_file()]
    files_dict = dict()
    for file_path in files_path:
        params = {'apikey': utils['api_key']}
        files = {"file": (os.path.basename(file_path), open(os.path.abspath(file_path), "rb"))}
        response = requests.post(utils['load_api'], files=files, params=params)
        files_dict[os.path.basename(file_path)] = response.json()['scan_id']
    return files_dict


def scan_files(files, threshold=.6):
    """
    This function takes in a files dictionary as a parameter, where the keys are file names and the values are file
    IDs, and a threshold as a floating point number that represents a threshold for determining if a file is
    considered a "false positive." The function uses the file_id and api_key from 'virustotal_utils.json' to send a GET request
    to the specified report_api and checks whether the ratio of positive results to total results is greater than the
    threshold. If it is, the name of the file is added to the false_pos list.

    :param files: dictionary, where the keys are file names and the values are file IDs
    :param threshold: float, threshold for determining if a file is considered a "false positive."
    :return: list, containing the file names that are considered false positives
    """
    with open('files/virustotal_utils.json') as json_file:
        utils = json.load(json_file)

    false_pos = list()
    for file_name, file_id in files.items():
        params = {'apikey': utils['api_key'], 'resource': file_id}
        response = requests.get(utils['report_api'], params=params)
        result_dict = response.json()
        if (result_dict['positives'] / result_dict['total']) > threshold:
            false_pos.append(file_name)
    return false_pos


def remove_files(directory_path, positive_files):
    """
    This function takes in a directory path and a list of positive files as parameters.
    It iterates through the positive_files list and removes the corresponding file in the directory_path.

    :param directory_path: string, the path of the directory where the files are located
    :param positive_files: list, containing the names of the files to be removed
    """
    for file in positive_files:
        file_path = os.path.join(directory_path, file)
        os.remove(file_path)
