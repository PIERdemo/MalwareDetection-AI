import os
import random
import re
from pathlib import Path
import lief as lief
from tqdm import tqdm

from methods.utils import append_to_csv


def extract_API(file_path):
    """
    Thanks to the lief library, it is extracted, given the file path, all the APIs that are used by it.

    :param file_path: a string with the absolute path to the file to be parsed
    :return: a dictionary where there are two items, in the first a string representing the target class to which the
    'target_class' file belongs , the second a string with all API functions, divided by a space 'API_calls'
    """
    exe_functions = list()
    exe = lief.parse(file_path)

    if exe is None or isinstance(exe, lief.ELF.Binary):
        return None

    for imported_library in exe.imports:
        exe_functions.extend([func.name for func in imported_library.entries])

    API_strings = _API_clean(exe_functions)

    return None if API_strings is None else {'target_class': file_path.split(os.sep)[-2], 'API_calls': API_strings}


def _API_clean(exe_functions):
    for function in exe_functions:
        if re.search(r'[\n\r\t,;|]', function):
            return None

    functions_string = ' '.join(exe_functions)
    functions_string = re.sub(" +", " ", functions_string)
    functions_string = functions_string.strip()
    if len(functions_string) == 0 or functions_string.isspace():
        return None
    return functions_string


def API(directory_path, csv_path, max_samples=None):
    """
    Given an input folder are extracted all API functions from all files and writes the result to a csv file

    :param directory_path: the path to the root folder in which to perform the analysis
    :param csv_path: the path to the csv file, if not present this will be created
    :param max_samples: maximum number of samples to want to analyze, they are randomly drawn from all those in the directory_path
    :return:
    """
    files_path = [str(x) for x in Path(directory_path).rglob('*') if x.is_file()]

    if max_samples is not None:
        random.shuffle(files_path)
        files_path = files_path[:max_samples]

    for file_path in tqdm(files_path):
        file_extraction = extract_API(file_path)
        if file_extraction is not None:
            append_to_csv(csv_path, file_extraction)
